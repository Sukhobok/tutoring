$(function(){$(".header-notice").html("Please wait ...")});var session_finished=!1,waiting_interval=!1,ts_socket="local"===environment?io.connect("http://studysquare.lh:53101"):io.connect("http://beta.studysquare.com:53101");
ts_socket.on("waiting",function(a){var b=convert_seconds(a.time-Math.round(Date.now()/1E3));$(".header-notice").html('Waiting for the other user ... Auto-cancel in <span class="special">'+b+"</span> minutes!");waiting_interval=setInterval(function(a){a=convert_seconds(a-Math.round(Date.now()/1E3));$(".header-notice").html('Waiting for the other user ... Auto-cancel in <span class="special">'+a+"</span> minutes!")},1E3,a.time)});
ts_socket.on("canceled",function(){session_finished=!0;!1!==waiting_interval&&(clearInterval(waiting_interval),$(".header-notice").html(""));$(".ss-modal-ts-finished-cases").hide();$(".ss-modal-ts-finished-case2").show();$.ssModal({modalId:"ts-finished",canBeClosed:0});if($(".ss-modal-ts-finished-complaint"))var a=300,b=setInterval(function(){a--;0>=a?(clearInterval(b),$(".ss-modal-ts-finished-complaint-send").remove(),$(".ss-modal-ts-finished-save").remove()):$(".ss-modal-ts-finished-complaint").text(convert_seconds(a))},
1E3)});
ts_socket.on("finished",function(){session_finished=!0;!1!==waiting_interval&&(clearInterval(waiting_interval),$(".header-notice").html(""));$(".ss-modal-ts-finished-cases").hide();$(".ss-modal-ts-finished-case1").show();$.ssModal({modalId:"ts-finished",canBeClosed:0});if($(".ss-modal-ts-finished-complaint"))var a=300,b=setInterval(function(){a--;0>=a?(clearInterval(b),$(".ss-modal-ts-finished-complaint-send").remove(),$(".ss-modal-ts-finished-save").remove()):$(".ss-modal-ts-finished-complaint").text(convert_seconds(a))},1E3)});
ts_socket.on("started",function(a){$.ssModal({modalId:"ts-started"});startVideo();!1!==waiting_interval&&(clearInterval(waiting_interval),$(".header-notice").html(""));var b=convert_seconds(a.finish_time-Math.round(Date.now()/1E3));$(".header-notice").html('The session will end in <span class="special">'+b+"</span> minutes!");waiting_interval=setInterval(function(a){a=convert_seconds(a-Math.round(Date.now()/1E3));$(".header-notice").html('The session will end in <span class="special">'+a+"</span> minutes!")},
1E3,a.finish_time)});var sourcevid=document.getElementById("webrtc-source"),remotevid=document.getElementById("webrtc-remote"),localStream=null,peerConn=null,mediaConstraints={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},_recordRTC=null;
function startVideo(){if(localStream)return!0;navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||window.navigator.mozGetUserMedia||navigator.msGetUserMedia;window.URL=window.URL||window.webkitURL;window.AudioContext=window.AudioContext||window.webkitAudioContext;navigator.getUserMedia({video:!0,audio:!0},function(a){localStream=a;_recordRTC=RecordRTC(localStream);_recordRTC.startRecording();sourcevid.mozSrcObject?sourcevid.mozSrcObject=localStream:(sourcevid.src=window.URL.createObjectURL(localStream),
sourcevid.muted=!0);sourcevid.play();connect()},function(a){console.log("Error code ["+a.code+"]")})}function toggleVideo(){localStream.getVideoTracks()[0].enabled=!localStream.getVideoTracks()[0].enabled}function toggleAudio(){localStream.getAudioTracks()[0].enabled=!localStream.getAudioTracks()[0].enabled}
function connect(){createPeerConnection();peerConn.createOffer(function(a){peerConn.setLocalDescription(a);ts_socket.json.send(a)},function(){console.log("Create offer failed")},mediaConstraints)}function stop(){peerConn.close();peerConn=null}
ts_socket.on("message",function(a){"offer"===a.type?(createPeerConnection(),peerConn.setRemoteDescription(new RTCSessionDescription(a)),peerConn.createAnswer(function(a){peerConn.setLocalDescription(a);ts_socket.json.send(a)},function(){console.log("Create answer failed")},mediaConstraints)):"answer"===a.type?peerConn.setRemoteDescription(new RTCSessionDescription(a)):"candidate"===a.type&&(a=new RTCIceCandidate({sdpMLineIndex:a.sdpMLineIndex,sdpMid:a.sdpMid,candidate:a.candidate}),peerConn.addIceCandidate(a))});
function createPeerConnection(){console.log("Creating peer connection");peerConn=new (webkitRTCPeerConnection||mozRTCPeerConnection)({iceServers:[{url:"stun:stun.l.google.com:19302"}]});localStream&&peerConn.addStream(localStream);peerConn.onicecandidate=function(a){event.candidate&&ts_socket.json.send({type:"candidate",sdpMLineIndex:a.candidate.sdpMLineIndex,sdpMid:a.candidate.sdpMid,candidate:a.candidate.candidate})};peerConn.addEventListener("addstream",function(a){remotevid.src=window.URL.createObjectURL(a.stream);
remotevid.play()},!1);peerConn.addEventListener("removestream",function(a){remotevid.src=""},!1)}function xhr(a,b,d){var c=new XMLHttpRequest;c.onreadystatechange=function(){4==c.readyState&&200==c.status&&d(location.href+c.responseText)};c.open("POST",a);c.send(b)}
function end_audio_recording(){_recordRTC&&_recordRTC.stopRecording(function(a){_recordRTC.startRecording();var b=new XMLHttpRequest;b.open("GET",a,!0);b.responseType="blob";b.onload=function(a){a=this.response;var b=new FormData;b.append("audio-filename","recording.wav");b.append("audio-blob",a);xhr("/ajax/session/receive_audio",b,function(a){})};b.send()})}setInterval(function(){session_finished||end_audio_recording()},6E4);$(".ts-cam-toggle").change(function(){toggleVideo()});$(".ts-mic-toggle").change(function(){toggleAudio()});var tsInitText=function(a){tinymce.init({selector:"textarea#ts-text-textarea",width:718,height:397,resize:!1,statusbar:!1,setup:a,plugins:["advlist autolink lists link image charmap print preview anchor","searchreplace visualblocks fullscreen","insertdatetime media table contextmenu paste"],menu:{file:{title:"File",items:"save_file print"},edit:{title:"Edit",items:"undo redo | cut copy paste | selectall | searchreplace"},insert:{title:"Insert",items:"image link | charmap insertdatetime"},view:{title:"View",
items:"visualaid | preview fullscreen"},format:{title:"Format",items:"bold italic underline strikethrough superscript subscript | formats | removeformat"},table:{title:"Table",items:"inserttable tableprops deletetable | cell row column"}},toolbar:"insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image"})};var tsTextSend=function(a){ts_socket.emit("tutoring_session_data",{what:"text",value:a})},tsTextReceive;tsInitText(function(a){a.addMenuItem("save_file",{text:"Save file",onclick:function(){a.insertContent("Some content")}});a.on("keyup",function(b){tsTextSend(a.getContent())});a.on("change",function(b){tsTextSend(a.getContent())});tsTextReceive=function(b){a.setContent(b)}});var tsCodingEditor=ace.edit("ts-coding-editor");tsCodingEditor.setTheme("ace/theme/monokai");tsCodingEditor.getSession().setMode("ace/mode/text");
var undoManager=tsCodingEditor.getSession().getUndoManager(),tsCodingChangeLang=function(a){tsCodingEditor.getSession().setMode("ace/mode/"+a);$(".ts-coding-sidebar-lang").removeClass("is-selected");$('[data-ts-coding-lang="'+a+'"]').addClass("is-selected")},tsCodingChangeTemplate=function(a){tsCodingEditor.setTheme("ace/theme/"+a);$(".ts-coding-sidebar-template").removeClass("is-selected");$('[data-ts-coding-template="'+a+'"]').addClass("is-selected")},tsCodingAction=function(a){switch(a){case "undo":undoManager.undo();
break;case "redo":undoManager.redo()}};$(document).on("click",".ts-coding-sidebar-lang",function(){tsCodingChangeLang(this.getAttribute("data-ts-coding-lang"));ts_socket.emit("tutoring_session_data",{what:"coding",action:"change_language",value:this.getAttribute("data-ts-coding-lang")})});$(document).on("click",".ts-coding-sidebar-template",function(){tsCodingChangeTemplate(this.getAttribute("data-ts-coding-template"));ts_socket.emit("tutoring_session_data",{what:"coding",action:"change_template",value:this.getAttribute("data-ts-coding-template")})});
$(document).on("click",".ts-coding-sidebar-action",function(){tsCodingAction(this.getAttribute("data-ts-coding-action"));ts_socket.emit("tutoring_session_data",{what:"coding",action:"action",value:this.getAttribute("data-ts-coding-action")})});$("#ts-coding-editor").on("keyup click",function(a){a={};a.cursor_at=tsCodingEditor.selection.getCursor();a.code_data=tsCodingEditor.getValue();ts_socket.emit("tutoring_session_data",{what:"coding",action:"data",value:a})});var tsSelectMode=function(a){$(".ts-mode-tools-top").addClass("hide");$('.ts-mode-tools-top[data-ts-mode="'+a+'"]').removeClass("hide");$(".ts-mode-select").removeClass("is-selected");$('.ts-mode-select[data-ts-mode-select="'+a+'"]').addClass("is-selected");$(".ts-modes").addClass("hide");$('.ts-modes[data-ts-mode="'+a+'"]').removeClass("hide")};$(document).on("click",".ts-mode-select",function(){var a=this.getAttribute("data-ts-mode-select");tsSelectMode(a);ts_socket.emit("tutoring_session_data",{what:"mode",mode:a})});var tsChatAdd=function(a,b){b="undefined"!==typeof b?b:0;var d=$('<div class="ts-chat-message ts-chat-message-'+b+'"></div>'),c=$('<span class="ts-chat-message-name"></span>');1==b?c.text(partner_name):c.text(current_name);var e=$('<span class="ts-chat-message-content"></span>');e.text(": "+a);d.append(c);d.append(e);$(".ts-chat-messages").append(d);$(".ts-chat-messages").animate({scrollTop:$(".ts-chat-messages")[0].scrollHeight},1E3)};$(document).on("keyup",".ts-chat-textarea",function(a){13===a.keyCode&&($("#ts-chat-pressing-enter-cb").is(":checked")&&""!==$.trim($(".ts-chat-textarea").val()))&&(tsChatAdd($.trim($(".ts-chat-textarea").val())),ts_socket.emit("tutoring_session_data",{what:"chat",message:$.trim($(".ts-chat-textarea").val())}),$(".ts-chat-textarea").val(""))});
$(document).on("click",".ts-chat-send",function(){""!==$.trim($(".ts-chat-textarea").val())&&(tsChatAdd($.trim($(".ts-chat-textarea").val())),ts_socket.emit("tutoring_session_data",{what:"chat",message:$.trim($(".ts-chat-textarea").val())}),$(".ts-chat-textarea").val(""))});$(document).on("mouseenter",".ts-file-manager-file",function(){$(".ts-file-manager-file-actions",this).fadeIn()}).on("mouseleave",".ts-file-manager-file",function(){$(".ts-file-manager-file-actions",this).fadeOut()});$("#ss-modal-ts-finished-stars").on("click",".ss-modal-ts-finished-star",function(){var a=$(".ss-modal-ts-finished-star").index(this);$(".ss-modal-ts-finished-star").attr("src","/images/rating_empty.png");$(".ss-modal-ts-finished-star").slice(0,a+1).attr("src","/images/rating_full.png");$(this).parent()[0].setAttribute("data-ss-stars-amount",a+1)}).on("mouseenter",".ss-modal-ts-finished-star",function(){var a=$(".ss-modal-ts-finished-star").index(this);$(".ss-modal-ts-finished-star").attr("src","/images/rating_empty.png");
$(".ss-modal-ts-finished-star").slice(0,a+1).attr("src","/images/rating_full.png")}).on("mouseleave",".ss-modal-ts-finished-star",function(){var a=parseInt($(this).parent()[0].getAttribute("data-ss-stars-amount"),10);$(".ss-modal-ts-finished-star").attr("src","/images/rating_empty.png");$(".ss-modal-ts-finished-star").slice(0,a).attr("src","/images/rating_full.png")});
$("#ss-modal-ts-finished").on("click",".ss-modal-ts-finished-rate-tutor",function(){$(this).remove();$.ajax({url:"/ajax/session/leave_feedback",type:"POST",data:{ts_id:global_ts_id,stars:$("#ss-modal-ts-finished-stars")[0].getAttribute("data-ss-stars-amount"),message:$("#ss-modal-ts-finished-feedback textarea").val()}}).done(function(){window.location.href="/dashboard"})});
$("#ss-modal-ts-finished").on("click",".ss-modal-ts-finished-complaint-send",function(){$(this).remove();$.ajax({url:"/ajax/session/send_complaint",type:"POST",data:{ts_id:global_ts_id}}).done(function(){})});$("#ss-modal-ts-finished").on("click",".ss-modal-ts-finished-save",function(){$(this).remove();$.ajax({url:"/ajax/session/save",type:"POST",data:{ts_id:global_ts_id}}).done(function(){})});
