$(function(){$(".header-notice").html("Please wait ...")});var session_finished=!1,waiting_interval=!1,ts_socket="local"===environment?io.connect("http://studysquare.lh:53101"):io.connect("https://studysquare.com:53101",{secure:!0});
ts_socket.on("waiting",function(a){var b=convert_seconds(a.time-Math.round(Date.now()/1E3));$(".header-notice").html('Waiting for the other user ... Auto-cancel in <span class="special">'+b+"</span> minutes!");waiting_interval=setInterval(function(a){a=convert_seconds(a-Math.round(Date.now()/1E3));$(".header-notice").html('Waiting for the other user ... Auto-cancel in <span class="special">'+a+"</span> minutes!")},1E3,a.time)});
ts_socket.on("canceled",function(){session_finished=!0;!1!==waiting_interval&&(clearInterval(waiting_interval),$(".header-notice").html(""));$(".ss-modal-ts-finished-cases").hide();$(".ss-modal-ts-finished-case2").show();$.ssModal({modalId:"ts-finished",canBeClosed:0});if($(".ss-modal-ts-finished-complaint"))var a=300,b=setInterval(function(){a--;0>=a?(clearInterval(b),$(".ss-modal-ts-finished-complaint-send").remove(),$(".ss-modal-ts-finished-save").remove()):$(".ss-modal-ts-finished-complaint").text(convert_seconds(a))},
1E3)});
ts_socket.on("finished",function(){session_finished=!0;!1!==waiting_interval&&(clearInterval(waiting_interval),$(".header-notice").html(""));$(".ss-modal-ts-finished-cases").hide();$(".ss-modal-ts-finished-case1").show();$.ssModal({modalId:"ts-finished",canBeClosed:0});if($(".ss-modal-ts-finished-complaint"))var a=300,b=setInterval(function(){a--;0>=a?(clearInterval(b),$(".ss-modal-ts-finished-complaint-send").remove(),$(".ss-modal-ts-finished-save").remove()):$(".ss-modal-ts-finished-complaint").text(convert_seconds(a))},1E3)});
ts_socket.on("started",function(a){$.ssModal({modalId:"ts-started"});startVideo();!1!==waiting_interval&&(clearInterval(waiting_interval),$(".header-notice").html(""));var b=convert_seconds(a.finish_time-Math.round(Date.now()/1E3));$(".header-notice").html('The session will end in <span class="special">'+b+"</span> minutes!");waiting_interval=setInterval(function(a){a=convert_seconds(a-Math.round(Date.now()/1E3));$(".header-notice").html('The session will end in <span class="special">'+a+"</span> minutes!")},
1E3,a.finish_time)});var webrtc=null,audio_mute=!1,video_pause=!1,startVideo=function(){webrtc=new SimpleWebRTC({localVideoEl:"webrtc-source",remoteVideosEl:"webrtc-remote",autoRequestMedia:!0});webrtc.on("readyToCall",function(){webrtc.joinRoom(window.global_ts_id)});$(".ts-cam-toggle").change(function(){video_pause?webrtc.resumeVideo():webrtc.pauseVideo();video_pause=!video_pause});$(".ts-mic-toggle").change(function(){audio_mute?webrtc.unmute():webrtc.mute();audio_mute=!audio_mute})};var tsInitText=function(a){tinymce.init({selector:"textarea#ts-text-textarea",width:718,height:397,resize:!1,statusbar:!1,setup:a,plugins:["advlist autolink lists link image charmap print preview anchor","searchreplace visualblocks fullscreen","insertdatetime media table contextmenu paste"],menu:{file:{title:"File",items:"save_file print"},edit:{title:"Edit",items:"undo redo | cut copy paste | selectall | searchreplace"},insert:{title:"Insert",items:"image link | charmap insertdatetime"},view:{title:"View",
items:"visualaid | preview fullscreen"},format:{title:"Format",items:"bold italic underline strikethrough superscript subscript | formats | removeformat"},table:{title:"Table",items:"inserttable tableprops deletetable | cell row column"}},toolbar:"insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image"})};var tsTextSend=function(a){ts_socket.emit("tutoring_session_data",{what:"text",value:a})},tsTextReceive;tsInitText(function(a){a.addMenuItem("save_file",{text:"Save file",onclick:function(){a.insertContent("Some content")}});a.on("keyup",function(b){tsTextSend(a.getContent())});a.on("change",function(b){tsTextSend(a.getContent())});tsTextReceive=function(b){a.setContent(b)}});var tsCodingEditor=ace.edit("ts-coding-editor");tsCodingEditor.setTheme("ace/theme/monokai");tsCodingEditor.getSession().setMode("ace/mode/text");
var undoManager=tsCodingEditor.getSession().getUndoManager(),tsCodingChangeLang=function(a){tsCodingEditor.getSession().setMode("ace/mode/"+a);$(".ts-coding-sidebar-lang").removeClass("is-selected");$('[data-ts-coding-lang="'+a+'"]').addClass("is-selected")},tsCodingChangeTemplate=function(a){tsCodingEditor.setTheme("ace/theme/"+a);$(".ts-coding-sidebar-template").removeClass("is-selected");$('[data-ts-coding-template="'+a+'"]').addClass("is-selected")},tsCodingAction=function(a){switch(a){case "undo":undoManager.undo();
break;case "redo":undoManager.redo()}};$(document).on("click",".ts-coding-sidebar-lang",function(){tsCodingChangeLang(this.getAttribute("data-ts-coding-lang"));ts_socket.emit("tutoring_session_data",{what:"coding",action:"change_language",value:this.getAttribute("data-ts-coding-lang")})});$(document).on("click",".ts-coding-sidebar-template",function(){tsCodingChangeTemplate(this.getAttribute("data-ts-coding-template"));ts_socket.emit("tutoring_session_data",{what:"coding",action:"change_template",value:this.getAttribute("data-ts-coding-template")})});
$(document).on("click",".ts-coding-sidebar-action",function(){tsCodingAction(this.getAttribute("data-ts-coding-action"));ts_socket.emit("tutoring_session_data",{what:"coding",action:"action",value:this.getAttribute("data-ts-coding-action")})});$("#ts-coding-editor").on("keyup click",function(a){a={};a.cursor_at=tsCodingEditor.selection.getCursor();a.code_data=tsCodingEditor.getValue();ts_socket.emit("tutoring_session_data",{what:"coding",action:"data",value:a})});var tsSelectMode=function(a){$(".ts-mode-tools-top").addClass("hide");$('.ts-mode-tools-top[data-ts-mode="'+a+'"]').removeClass("hide");$(".ts-mode-select").removeClass("is-selected");$('.ts-mode-select[data-ts-mode-select="'+a+'"]').addClass("is-selected");$(".ts-modes").addClass("hide");$('.ts-modes[data-ts-mode="'+a+'"]').removeClass("hide")};$(document).on("click",".ts-mode-select",function(){var a=this.getAttribute("data-ts-mode-select");tsSelectMode(a);ts_socket.emit("tutoring_session_data",{what:"mode",mode:a})});var tsChatAdd=function(a,b){b="undefined"!==typeof b?b:0;var c=$('<div class="ts-chat-message ts-chat-message-'+b+'"></div>'),d=$('<span class="ts-chat-message-name"></span>');1==b?d.text(partner_name):d.text(current_name);var e=$('<span class="ts-chat-message-content"></span>');e.text(": "+a);c.append(d);c.append(e);$(".ts-chat-messages").append(c);$(".ts-chat-messages").animate({scrollTop:$(".ts-chat-messages")[0].scrollHeight},1E3)};$(document).on("keyup",".ts-chat-textarea",function(a){13===a.keyCode&&($("#ts-chat-pressing-enter-cb").is(":checked")&&""!==$.trim($(".ts-chat-textarea").val()))&&(tsChatAdd($.trim($(".ts-chat-textarea").val())),ts_socket.emit("tutoring_session_data",{what:"chat",message:$.trim($(".ts-chat-textarea").val())}),$(".ts-chat-textarea").val(""))});
$(document).on("click",".ts-chat-send",function(){""!==$.trim($(".ts-chat-textarea").val())&&(tsChatAdd($.trim($(".ts-chat-textarea").val())),ts_socket.emit("tutoring_session_data",{what:"chat",message:$.trim($(".ts-chat-textarea").val())}),$(".ts-chat-textarea").val(""))});var tsNewFile=function(a){var b=$(".snippet-ts-file-manager-file").clone().removeClass("snippet-ts-file-manager-file"),c=12<a.filename.length?a.filename.substr(0,12)+"...":a.filename;$(".ts-file-manager-file-actions",b)[0].setAttribute("data-ss-file",a.filename);$(".ts-file-manager-file-caption",b).text(c);$(".ts-file-manager-file-caption",b).attr("title",a.filename);$(".ts-file-manager-file-icon",b).attr("src",a.icon);$(".ts-file-manager-file-icon",b).attr("alt",a.filename);$(".ts-file-manager-files").append(b);
b.removeClass("hide");$(".ts-file-manager-count").text(parseInt($(".ts-file-manager-count").text(),10)+1)},tsDownloadFile=function(a){window.open("/ajax/session/download_file?file="+a)},tsRemoveFile=function(a){$('.ts-file-manager-file-actions[data-ss-file="'+a+'"]')&&($('.ts-file-manager-file-actions[data-ss-file="'+a+'"]').parents(".ts-file-manager-file").remove(),$(".ts-file-manager-count").text(parseInt($(".ts-file-manager-count").text(),10)-1))};$(document).on("mouseenter",".ts-file-manager-file",function(){$(".ts-file-manager-file-actions",this).fadeIn()}).on("mouseleave",".ts-file-manager-file",function(){$(".ts-file-manager-file-actions",this).fadeOut()});$(document).on("click",".ts-file-manager-file-action",function(){var a=this.getAttribute("data-ss-action"),b=$(this).parent().data("ss-file");"download"==a?tsDownloadFile(b):"remove"==a&&$.ajax({url:"/ajax/session/remove_file",type:"POST",data:{file:b}}).done(function(a){})});
$(document).on("change",'input[name="ts-file-upload"]',function(){var a=new XMLHttpRequest,b=new FormData;b.append("ts-file",this.files[0]);a.open("POST","/ajax/session/receive_file",!0);a.send(b);a.onreadystatechange=function(){4==a.readyState&&200==a.status&&JSON.parse(a.responseText)}});window.onbeforeunload=function(){if(!session_finished)return"Navigating away from this page will terminate your tutoring session and all the progress will be lost!"};$(document).on("click",".ts-close-session",function(){$(this).css({visibility:"hidden"});$.ajax({url:"/ajax/session/close_session",type:"POST",data:{}}).done(function(a){})});
$("#ss-modal-ts-finished-stars").on("click",".ss-modal-ts-finished-star",function(){var a=$(".ss-modal-ts-finished-star").index(this);$(".ss-modal-ts-finished-star").attr("src","/images/rating_empty.png");$(".ss-modal-ts-finished-star").slice(0,a+1).attr("src","/images/rating_full.png");$(this).parent()[0].setAttribute("data-ss-stars-amount",a+1)}).on("mouseenter",".ss-modal-ts-finished-star",function(){var a=$(".ss-modal-ts-finished-star").index(this);$(".ss-modal-ts-finished-star").attr("src","/images/rating_empty.png");
$(".ss-modal-ts-finished-star").slice(0,a+1).attr("src","/images/rating_full.png")}).on("mouseleave",".ss-modal-ts-finished-star",function(){var a=parseInt($(this).parent()[0].getAttribute("data-ss-stars-amount"),10);$(".ss-modal-ts-finished-star").attr("src","/images/rating_empty.png");$(".ss-modal-ts-finished-star").slice(0,a).attr("src","/images/rating_full.png")});
$("#ss-modal-ts-finished").on("click",".ss-modal-ts-finished-rate-tutor",function(){$(this).remove();$.ajax({url:"/ajax/session/leave_feedback",type:"POST",data:{ts_id:global_ts_id,stars:$("#ss-modal-ts-finished-stars")[0].getAttribute("data-ss-stars-amount"),message:$("#ss-modal-ts-finished-feedback textarea").val()}}).done(function(){window.location.href="/dashboard"})});
$("#ss-modal-ts-finished").on("click",".ss-modal-ts-finished-complaint-send",function(){$(this).remove();$(".ss-modal-ts-finished-complaint-pre-message").removeClass("hide");$.ajax({url:"/ajax/session/send_complaint",type:"POST",data:{ts_id:global_ts_id}}).done(function(){$(".ss-modal-ts-finished-complaint-pre-message").text("Your complaint was sent successfully!")})});
$("#ss-modal-ts-finished").on("click",".ss-modal-ts-finished-save",function(){$(this).remove();$.ajax({url:"/ajax/session/save",type:"POST",data:{ts_id:global_ts_id}}).done(function(){})});
